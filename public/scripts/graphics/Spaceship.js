var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

SPACE.Spaceship = (function(_super) {
  __extends(Spaceship, _super);

  Spaceship.prototype.time = 0;

  Spaceship.prototype.ship = null;

  Spaceship.prototype.path = null;

  Spaceship.prototype.duration = 0;

  Spaceship.prototype.songDuration = 0;

  Spaceship.prototype.state = null;

  Spaceship.prototype.angle = 0;

  Spaceship.prototype._cached = null;

  Spaceship.IDLE = 'IDLE';

  Spaceship.LAUNCHED = 'LAUNCHED';

  Spaceship.IN_LOOP = 'IN_LOOP';

  Spaceship.ARRIVED = 'ARRIVED';

  function Spaceship(target, radius) {
    Spaceship.__super__.constructor.apply(this, arguments);
    this.target = target;
    this.radius = radius;
    this.angle = Math.random() * Math.PI * 2;
    this.setState(SPACE.Spaceship.IDLE);
    this.setup();
  }

  Spaceship.prototype.setRadius = function(radius) {
    this.radius = radius;
    return this._cached = this._computePaths();
  };

  Spaceship.prototype.setup = function() {
    var g, matrix, v;
    g = new THREE.Geometry();
    g.vertices.push(new THREE.Vector3(0, -52.5, -10), new THREE.Vector3(-10, -67.5, 10), new THREE.Vector3(-50, -42.5, 10), new THREE.Vector3(0, 67.5, 10), new THREE.Vector3(+50, -42.5, 10), new THREE.Vector3(+10, -67.5, 10));
    g.faces.push(new THREE.Face3(0, 3, 1), new THREE.Face3(1, 2, 3), new THREE.Face3(3, 0, 5), new THREE.Face3(5, 4, 3));
    g.computeFaceNormals();
    matrix = new THREE.Matrix4();
    matrix.makeRotationX(Math.PI * .5);
    g.applyMatrix(matrix);
    matrix.makeRotationZ(Math.PI);
    g.applyMatrix(matrix);
    this.ship = THREE.SceneUtils.createMultiMaterialObject(g, [
      new THREE.MeshLambertMaterial({
        color: 0x0088ff,
        side: THREE.DoubleSide
      })
    ]);
    this.ship.castShadow = true;
    this.ship.receiveShadow = true;
    this.ship.scale.set(.15, .15, .15);
    this.add(this.ship);
    this._cached = this._computePaths();
    v = this._cached.launchedPath.getPointAt(0);
    return this.ship.position.set(v.x, v.y, v.z);
  };

  Spaceship.prototype.setState = function(state) {
    var v;
    this.state = state;
    switch (state) {
      case SPACE.Spaceship.IDLE:
        return this.path = null;
      case SPACE.Spaceship.LAUNCHED:
        SPACE.LOG('LAUNCHED');
        this._resetTime();
        this.path = this._cached.launchedPath;
        this.duration = 10 * 1000;
        v = this.path.getPoint(0);
        return this.ship.position.set(v.x, v.y, v.z);
      case SPACE.Spaceship.IN_LOOP:
        SPACE.LOG('IN_LOOP');
        this._resetTime();
        this.path = this._cached.inLoopPath;
        this.duration = this.songDuration;
        v = this.path.getPoint(0);
        return this.ship.position.set(v.x, v.y, v.z);
      case SPACE.Spaceship.ARRIVED:
        SPACE.LOG('ARRIVED');
        this.path = null;
        return this.parent.remove(this);
      default:
        return this.setState(SPACE.Spaceship.IDLE);
    }
  };

  Spaceship.prototype.update = function(delta) {
    var t;
    if (this.state !== SPACE.Spaceship.IDLE && this.state !== SPACE.Spaceship.ARRIVED) {
      t = Math.min(this.time / this.duration, 1);
      if (t >= 1) {
        this._resetTime();
        if (this.state === SPACE.Spaceship.LAUNCHED) {
          this.setState(SPACE.Spaceship.IN_LOOP);
        } else if (this.state === SPACE.Spaceship.IN_LOOP) {
          this.setState(SPACE.Spaceship.ARRIVED);
        }
        return;
      }
      if (this.state === SPACE.Spaceship.LAUNCHED) {
        this.time += delta;
        t = _Easing.QuadraticEaseOut(t);
      }
      return this._progress(t);
    }
  };

  Spaceship.prototype._resetTime = function() {
    return this.time = 0;
  };

  Spaceship.prototype._progress = function(t) {
    var ahead, v;
    v = this.path.getPointAt(t);
    this.ship.position.set(v.x, v.y, v.z);
    ahead = Math.min(t + 10 / this.path.getLength(), 1);
    v = this.path.getPointAt(ahead).multiplyScalar(1);
    this.ship.lookAt(v);
    if (this.state === SPACE.Spaceship.IN_LOOP) {
      return this.ship.rotation.set(this.ship.rotation.x, this.ship.rotation.y, 0);
    }
  };

  Spaceship.prototype._computePaths = function() {
    var angle, curve, curveA, curveB, curvePoint, distance, fromA, mid, path, points, ref, toA;
    fromA = new THREE.Vector3();
    fromA.x = this.target.x + Math.cos(this.angle) * 500;
    fromA.y = this.target.y + Math.sin(this.angle) * 500;
    fromA.z = 600;
    path = new THREE.IncomingCurve(this.target, this.angle, this.radius);
    path.inverse = true;
    path.useGolden = true;
    mid = path.getPoint(0);
    ref = path.getPoint(.025);
    angle = _Math.angleBetweenPoints(mid, ref) + Math.PI;
    distance = mid.distanceTo(ref);
    curvePoint = new THREE.Vector3();
    curvePoint.x = mid.x + Math.cos(angle) * distance;
    curvePoint.y = mid.y + Math.sin(angle) * distance;
    curvePoint.z = mid.z;
    toA = path.getPoint(0);
    curve = new THREE.TestCurve(fromA, curvePoint);
    points = curve.getPoints(10);
    points.push(toA);
    curveA = _THREE.HermiteCurve(points);
    curveB = _THREE.HermiteCurve(path.getPoints(10));
    return {
      launchedPath: curveA,
      inLoopPath: curveB
    };
  };

  Spaceship.prototype._debugPath = function(path, color) {
    var g, tube;
    if (color == null) {
      color = 0xFF0000;
    }
    g = new THREE.TubeGeometry(path, 200, .5, 10, true);
    tube = THREE.SceneUtils.createMultiMaterialObject(g, [
      new THREE.MeshBasicMaterial({
        color: color,
        opacity: 0.3,
        wireframe: true,
        transparent: true
      }), new THREE.MeshLambertMaterial({
        color: 0xFF88FF,
        side: THREE.DoubleSide
      })
    ]);
    return this.add(tube);
  };

  return Spaceship;

})(THREE.Group);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyYXBoaWNzL1NwYWNlc2hpcC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBQTtpU0FBQTs7QUFBQSxLQUFXLENBQUM7QUFFViw4QkFBQSxDQUFBOztBQUFBLHNCQUFBLElBQUEsR0FBTSxDQUFOLENBQUE7O0FBQUEsc0JBRUEsSUFBQSxHQUFNLElBRk4sQ0FBQTs7QUFBQSxzQkFHQSxJQUFBLEdBQU0sSUFITixDQUFBOztBQUFBLHNCQUlBLFFBQUEsR0FBVSxDQUpWLENBQUE7O0FBQUEsc0JBS0EsWUFBQSxHQUFjLENBTGQsQ0FBQTs7QUFBQSxzQkFPQSxLQUFBLEdBQU8sSUFQUCxDQUFBOztBQUFBLHNCQVNBLEtBQUEsR0FBTyxDQVRQLENBQUE7O0FBQUEsc0JBV0EsT0FBQSxHQUFTLElBWFQsQ0FBQTs7QUFBQSxFQWNBLFNBQUMsQ0FBQSxJQUFELEdBQVcsTUFkWCxDQUFBOztBQUFBLEVBZUEsU0FBQyxDQUFBLFFBQUQsR0FBVyxVQWZYLENBQUE7O0FBQUEsRUFnQkEsU0FBQyxDQUFBLE9BQUQsR0FBVyxTQWhCWCxDQUFBOztBQUFBLEVBaUJBLFNBQUMsQ0FBQSxPQUFELEdBQVcsU0FqQlgsQ0FBQTs7QUFtQmEsRUFBQSxtQkFBQyxNQUFELEVBQVMsTUFBVCxHQUFBO0FBQ1gsSUFBQSw0Q0FBQSxTQUFBLENBQUEsQ0FBQTtBQUFBLElBRUEsSUFBQyxDQUFBLE1BQUQsR0FBVSxNQUZWLENBQUE7QUFBQSxJQUdBLElBQUMsQ0FBQSxNQUFELEdBQVUsTUFIVixDQUFBO0FBQUEsSUFJQSxJQUFDLENBQUEsS0FBRCxHQUFVLElBQUksQ0FBQyxNQUFMLENBQUEsQ0FBQSxHQUFnQixJQUFJLENBQUMsRUFBckIsR0FBMEIsQ0FKcEMsQ0FBQTtBQUFBLElBTUEsSUFBQyxDQUFBLFFBQUQsQ0FBVSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQTFCLENBTkEsQ0FBQTtBQUFBLElBUUEsSUFBQyxDQUFBLEtBQUQsQ0FBQSxDQVJBLENBRFc7RUFB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LE1BQXBDLENBQUEiLCJmaWxlIjoiZ3JhcGhpY3MvU3BhY2VzaGlwLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgU1BBQ0UuU3BhY2VzaGlwIGV4dGVuZHMgVEhSRUUuR3JvdXBcblxuICB0aW1lOiAwXG5cbiAgc2hpcDogbnVsbFxuICBwYXRoOiBudWxsXG4gIGR1cmF0aW9uOiAwXG4gIHNvbmdEdXJhdGlvbjogMFxuXG4gIHN0YXRlOiBudWxsXG5cbiAgYW5nbGU6IDBcblxuICBfY2FjaGVkOiBudWxsXG5cbiAgIyBTVEFURVNcbiAgQElETEU6ICAgICAnSURMRSdcbiAgQExBVU5DSEVEOiAnTEFVTkNIRUQnXG4gIEBJTl9MT09QOiAgJ0lOX0xPT1AnXG4gIEBBUlJJVkVEOiAgJ0FSUklWRUQnXG5cbiAgY29uc3RydWN0b3I6ICh0YXJnZXQsIHJhZGl1cyktPlxuICAgIHN1cGVyXG5cbiAgICBAdGFyZ2V0ID0gdGFyZ2V0XG4gICAgQHJhZGl1cyA9IHJhZGl1c1xuICAgIEBhbmdsZSAgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDJcblxuICAgIEBzZXRTdGF0ZShTUEFDRS5TcGFjZXNoaXAuSURMRSlcblxuICAgIEBzZXR1cCgpXG5cbiAgICAjIHNldFRpbWVvdXQoPT5cbiAgICAjICAgQHNldFN0YXRlKFNQQUNFLlNwYWNlc2hpcC5MQVVOQ0hFRClcbiAgICAjICwgMjAwMClcblxuICBzZXRSYWRpdXM6IChyYWRpdXMpLT5cbiAgICBAcmFkaXVzID0gcmFkaXVzXG4gICAgQF9jYWNoZWQgPSBAX2NvbXB1dGVQYXRocygpXG5cbiAgc2V0dXA6IC0+XG4gICAgZyA9IG5ldyBUSFJFRS5HZW9tZXRyeSgpXG4gICAgZy52ZXJ0aWNlcy5wdXNoKFxuICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoICAwLCAtNTIuNSwgLTEwKVxuICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoLTEwLCAtNjcuNSwgIDEwKVxuICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoLTUwLCAtNDIuNSwgIDEwKVxuICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoICAwLCAgNjcuNSwgIDEwKVxuICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoKzUwLCAtNDIuNSwgIDEwKVxuICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoKzEwLCAtNjcuNSwgIDEwKVxuICAgIClcbiAgICBnLmZhY2VzLnB1c2goXG4gICAgICBuZXcgVEhSRUUuRmFjZTMoMCwgMywgMSksXG4gICAgICBuZXcgVEhSRUUuRmFjZTMoMSwgMiwgMyksXG4gICAgICBuZXcgVEhSRUUuRmFjZTMoMywgMCwgNSksXG4gICAgICBuZXcgVEhSRUUuRmFjZTMoNSwgNCwgMylcbiAgICApXG4gICAgZy5jb21wdXRlRmFjZU5vcm1hbHMoKVxuICAgIG1hdHJpeCA9IG5ldyBUSFJFRS5NYXRyaXg0KClcbiAgICBtYXRyaXgubWFrZVJvdGF0aW9uWChNYXRoLlBJKi41KVxuICAgIGcuYXBwbHlNYXRyaXgobWF0cml4KVxuICAgIG1hdHJpeC5tYWtlUm90YXRpb25aKE1hdGguUEkpXG4gICAgZy5hcHBseU1hdHJpeChtYXRyaXgpXG5cbiAgICBAc2hpcCA9IFRIUkVFLlNjZW5lVXRpbHMuY3JlYXRlTXVsdGlNYXRlcmlhbE9iamVjdChnLCBbXG4gICAgICBuZXcgVEhSRUUuTWVzaExhbWJlcnRNYXRlcmlhbCh7IGNvbG9yOiAweDAwODhmZiwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KVxuICAgIF0pXG4gICAgQHNoaXAuY2FzdFNoYWRvdyA9IHRydWVcbiAgICBAc2hpcC5yZWNlaXZlU2hhZG93ID0gdHJ1ZVxuICAgIEBzaGlwLnNjYWxlLnNldCguMTUsIC4xNSwgLjE1KVxuICAgIEBhZGQoQHNoaXApXG5cbiAgICBAX2NhY2hlZCA9IEBfY29tcHV0ZVBhdGhzKClcbiAgICB2ID0gQF9jYWNoZWQubGF1bmNoZWRQYXRoLmdldFBvaW50QXQoMClcbiAgICBAc2hpcC5wb3NpdGlvbi5zZXQodi54LCB2LnksIHYueilcblxuICBzZXRTdGF0ZTogKHN0YXRlKS0+XG4gICAgQHN0YXRlID0gc3RhdGVcbiAgICBzd2l0Y2ggc3RhdGVcbiAgICAgIHdoZW4gU1BBQ0UuU3BhY2VzaGlwLklETEVcbiAgICAgICAgIyBTUEFDRS5MT0coJ0lETEUnKVxuICAgICAgICBAcGF0aCA9IG51bGxcbiAgICAgIHdoZW4gU1BBQ0UuU3BhY2VzaGlwLkxBVU5DSEVEXG4gICAgICAgIFNQQUNFLkxPRygnTEFVTkNIRUQnKVxuICAgICAgICBAX3Jlc2V0VGltZSgpXG4gICAgICAgIEBwYXRoID0gQF9jYWNoZWQubGF1bmNoZWRQYXRoXG4gICAgICAgIEBkdXJhdGlvbiA9IDEwICogMTAwMFxuXG4gICAgICAgIHYgPSBAcGF0aC5nZXRQb2ludCgwKVxuICAgICAgICBAc2hpcC5wb3NpdGlvbi5zZXQodi54LCB2LnksIHYueilcbiAgICAgIHdoZW4gU1BBQ0UuU3BhY2VzaGlwLklOX0xPT1BcbiAgICAgICAgU1BBQ0UuTE9HKCdJTl9MT09QJylcbiAgICAgICAgQF9yZXNldFRpbWUoKVxuICAgICAgICBAcGF0aCA9IEBfY2FjaGVkLmluTG9vcFBhdGhcbiAgICAgICAgQGR1cmF0aW9uID0gQHNvbmdEdXJhdGlvblxuXG4gICAgICAgIHYgPSBAcGF0aC5nZXRQb2ludCgwKVxuICAgICAgICBAc2hpcC5wb3NpdGlvbi5zZXQodi54LCB2LnksIHYueilcbiAgICAgIHdoZW4gU1BBQ0UuU3BhY2VzaGlwLkFSUklWRURcbiAgICAgICAgU1BBQ0UuTE9HKCdBUlJJVkVEJylcbiAgICAgICAgQHBhdGggPSBudWxsXG4gICAgICAgIEBwYXJlbnQucmVtb3ZlKEApXG4gICAgICAgICMgX0gudHJpZ2dlcihKVUtFQk9YLklTX1NUT1BQRUQpICAgICAgXG4gICAgICBlbHNlXG4gICAgICAgIEBzZXRTdGF0ZShTUEFDRS5TcGFjZXNoaXAuSURMRSlcblxuICB1cGRhdGU6IChkZWx0YSktPlxuICAgIGlmIEBzdGF0ZSAhPSBTUEFDRS5TcGFjZXNoaXAuSURMRSBhbmQgQHN0YXRlICE9IFNQQUNFLlNwYWNlc2hpcC5BUlJJVkVEXG5cbiAgICAgIHQgPSBNYXRoLm1pbihAdGltZSAvIEBkdXJhdGlvbiwgMSlcblxuICAgICAgaWYgdCA+PSAxXG4gICAgICAgIEBfcmVzZXRUaW1lKClcbiAgICAgICAgaWYgQHN0YXRlID09IFNQQUNFLlNwYWNlc2hpcC5MQVVOQ0hFRFxuICAgICAgICAgIEBzZXRTdGF0ZShTUEFDRS5TcGFjZXNoaXAuSU5fTE9PUClcbiAgICAgICAgZWxzZSBpZiBAc3RhdGUgPT0gU1BBQ0UuU3BhY2VzaGlwLklOX0xPT1BcbiAgICAgICAgICBAc2V0U3RhdGUoU1BBQ0UuU3BhY2VzaGlwLkFSUklWRUQpXG4gICAgICAgIHJldHVyblxuXG4gICAgICBpZiBAc3RhdGUgPT0gU1BBQ0UuU3BhY2VzaGlwLkxBVU5DSEVEXG4gICAgICAgIEB0aW1lICs9IGRlbHRhXG4gICAgICAgIHQgPSBfRWFzaW5nLlF1YWRyYXRpY0Vhc2VPdXQodClcblxuICAgICAgQF9wcm9ncmVzcyh0KVxuXG4gIF9yZXNldFRpbWU6IC0+XG4gICAgQHRpbWUgPSAwXG5cbiAgX3Byb2dyZXNzOiAodCktPlxuICAgIHYgPSBAcGF0aC5nZXRQb2ludEF0KHQpXG4gICAgQHNoaXAucG9zaXRpb24uc2V0KHYueCwgdi55LCB2LnopXG5cbiAgICBhaGVhZCA9ICBNYXRoLm1pbih0ICsgMTAgLyBAcGF0aC5nZXRMZW5ndGgoKSwgMSlcbiAgICB2ID0gQHBhdGguZ2V0UG9pbnRBdChhaGVhZCkubXVsdGlwbHlTY2FsYXIoIDEgKVxuICAgIEBzaGlwLmxvb2tBdCh2KVxuXG4gICAgaWYgQHN0YXRlID09IFNQQUNFLlNwYWNlc2hpcC5JTl9MT09QXG4gICAgICBAc2hpcC5yb3RhdGlvbi5zZXQoQHNoaXAucm90YXRpb24ueCwgQHNoaXAucm90YXRpb24ueSwgMClcblxuICBfY29tcHV0ZVBhdGhzOiAtPlxuICAgIGZyb21BICAgICA9IG5ldyBUSFJFRS5WZWN0b3IzKClcbiAgICBmcm9tQS54ICAgPSBAdGFyZ2V0LnggKyBNYXRoLmNvcyhAYW5nbGUpICogNTAwXG4gICAgZnJvbUEueSAgID0gQHRhcmdldC55ICsgTWF0aC5zaW4oQGFuZ2xlKSAqIDUwMFxuICAgIGZyb21BLnogICA9IDYwMFxuXG4gICAgcGF0aCAgICAgICAgICAgPSBuZXcgVEhSRUUuSW5jb21pbmdDdXJ2ZShAdGFyZ2V0LCBAYW5nbGUsIEByYWRpdXMpXG4gICAgcGF0aC5pbnZlcnNlICAgPSB0cnVlXG4gICAgcGF0aC51c2VHb2xkZW4gPSB0cnVlXG5cbiAgICAjIyBDcmVhdGUgcGF0aCBsYXVuY2hlZFxuICAgIG1pZCAgICAgID0gcGF0aC5nZXRQb2ludCgwKVxuICAgIHJlZiAgICAgID0gcGF0aC5nZXRQb2ludCguMDI1KVxuICAgIGFuZ2xlICAgID0gX01hdGguYW5nbGVCZXR3ZWVuUG9pbnRzKG1pZCwgcmVmKSArIE1hdGguUElcbiAgICBkaXN0YW5jZSA9IG1pZC5kaXN0YW5jZVRvKHJlZilcblxuICAgIGN1cnZlUG9pbnQgICA9IG5ldyBUSFJFRS5WZWN0b3IzKClcbiAgICBjdXJ2ZVBvaW50LnggPSBtaWQueCArIE1hdGguY29zKGFuZ2xlKSAqIGRpc3RhbmNlXG4gICAgY3VydmVQb2ludC55ID0gbWlkLnkgKyBNYXRoLnNpbihhbmdsZSkgKiBkaXN0YW5jZVxuICAgIGN1cnZlUG9pbnQueiA9IG1pZC56XG5cbiAgICB0b0EgICAgPSBwYXRoLmdldFBvaW50KDApXG4gICAgY3VydmUgID0gbmV3IFRIUkVFLlRlc3RDdXJ2ZShmcm9tQSwgY3VydmVQb2ludClcbiAgICBwb2ludHMgPSBjdXJ2ZS5nZXRQb2ludHMoMTApXG4gICAgcG9pbnRzLnB1c2godG9BKVxuXG4gICAgY3VydmVBID0gX1RIUkVFLkhlcm1pdGVDdXJ2ZShwb2ludHMpXG5cbiAgICAjIyBDcmVhdGUgcGF0aCBpbiB0aGUgbG9vcFxuICAgIGN1cnZlQiA9IF9USFJFRS5IZXJtaXRlQ3VydmUocGF0aC5nZXRQb2ludHMoMTApKVxuICAgIHJldHVybiB7IGxhdW5jaGVkUGF0aDogY3VydmVBLCBpbkxvb3BQYXRoOiBjdXJ2ZUIgfVxuXG4gIF9kZWJ1Z1BhdGg6IChwYXRoLCBjb2xvcj0weEZGMDAwMCktPlxuICAgIGcgICAgPSBuZXcgVEhSRUUuVHViZUdlb21ldHJ5KHBhdGgsIDIwMCwgLjUsIDEwLCB0cnVlKVxuICAgIHR1YmUgPSBUSFJFRS5TY2VuZVV0aWxzLmNyZWF0ZU11bHRpTWF0ZXJpYWxPYmplY3QoIGcsIFtcbiAgICAgIG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7XG4gICAgICAgICAgY29sb3I6IGNvbG9yLFxuICAgICAgICAgIG9wYWNpdHk6IDAuMyxcbiAgICAgICAgICB3aXJlZnJhbWU6IHRydWUsXG4gICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWVcbiAgICAgIH0pLFxuICAgICAgbmV3IFRIUkVFLk1lc2hMYW1iZXJ0TWF0ZXJpYWwoeyBjb2xvcjogMHhGRjg4RkYsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUgfSlcbiAgICBdKVxuICAgIEBhZGQodHViZSlcbiJdfQ==